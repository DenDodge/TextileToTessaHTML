using System;
using System.Collections.Generic;
using TextileToTessaHTML;

namespace TestApp
{
    internal class Program
    {
        static void Main(string[] args)
        {
            Dictionary<string, Guid> attachemntsIds = new Dictionary<string, Guid>()
            {
                { "photo_2021-10-05_11-52-45.jpg", new Guid("49ba1622-55d9-48c5-a4d5-9a85801fd62a") },
                { "2.png", new Guid("8166b72b-3a3b-4198-9cb9-657da5d9f8ee") },
                { "07.11.12.png", new Guid("8b22ba42-6404-4130-bd1b-ff2fb037f893") }
            };

            string filesDirectory = $"D:\\WORK_SYNTELLECT\\OtherFiles\\Migration\\29906";

            string testString = "Алгоритм восстановления БД:\r\n1. Если требуется, выгрузить учетные записи сотрудников первой линии поддержки: выделить в представлении «Сотрудники» РМ «Администратор» нужные записи и произвести экспорт (левое меню – Экспорт или Ctrl+E) или иные карточки, необходимые для тестирования.\r\n{{collapse(см. рисунок:)\r\n!http://dl4.joxi.net/drive/2018/04/27/0020/1024/1319936/36/b1126662f3.jpg! \r\n}}\r\n2. Остановить службы Chronos на тестовом сервере.\r\n3. Осуществить восстановление БД, перед восстановлением потребуется закрыть все существующие соединения к базе.\r\n4. Удалить адреса электронной почты сотрудников. Выполнить сценарий обновления в БД\r\n{{collapse(sql-скрипт:)\r\n<pre>\r\nupdate PersonalRoles\r\nset Email = null\r\nwhere not Email is null;\r\n</pre>\r\n}}\r\n5. Для исключения воспроизведения ошибки при открытии приложений из TessaApplications, выполнить действия, описанные в задаче https://support.syntellect.ru/issues/9054\r\nили очистить таблицу с приложениями в БД\r\n{{collapse(sql-скрипт:)\r\n<pre>\r\ndelete from Applications\r\n</pre>\r\n}}\r\n6. Провести *удаление* конфиденциальных *документов*. Для удаления карточек можно использовать 2 варианта: средствами TessaClient или удаление записей из БД.\r\n6.1. _*Удаление карточек средствами TessaClient*_ подразумевает массовое удаление карточек из представлений, перед ускорения процесса можно провести следующие подготовительные работы:\r\n6.1.1. В TessaAdmin найти представления, которые выводят реестр карточек, подлежащих удалению, названия представлений можно посмотреть в РМ. Аналогичные настройки следует сделать и для представления Deleted, которое отображает перечень удаленных карточек.\r\n* В параметре метаданных #view указать свойтва:\r\n** Paging: optional - для отключения пейджинга из клиента\r\n** MultiSelect: true - разрешен множественный выбор\r\n{{collapse(см. рисунок:)\r\n!http://dl4.joxi.net/drive/2018/04/28/0020/1024/1319936/36/f9d1ee872d.jpg!\r\n}}\r\n* Убедиться, что в РМ разрешено множественное выделение строк в представлении (или установить данный параметр)\r\n{{collapse(см. рисунок:)\r\n!http://dl4.joxi.net/drive/2018/04/28/0020/1024/1319936/36/3cdc755c6e.jpg!\r\n}}\r\n* Произвести массовое удаление через TessaClient. \r\nДля этого нужно настроить параметры фильтрации для отбора карточек, которые требуется удалить, отключить постраничный вывод, выделить все строки в представлении (Ctrl+A) и произвести удаление выделенных карточек(_*левое меню - Другие - Удалить*_ или _*Ctrl+D*_)\r\nВозможно, потребуется несколько итераций удаления или зачистка ссылок в БД, в случае, если на какие-то карточки есть ссылки в других документах.\r\n* После удаления всех документов, выполнить те же действия, для представления, которое выводит реестр удаленных карточек (_*РМ Администратор - Прочее - Удаленные карточки*_).\r\n6.2. Удаление карточек из БД подразумевает удаление записей из таблиц Instances, Files, Tasks, а также таблиц, содержащих атрибуты карточки документа (полный перечень для каждого типа карточек можно посмотреть в разделе *Секции* нужного вида карточек в *TessaAdmin*)\r\nНиже приведен пример для удаления записей типа _*Договор с ЮЛ/ИП (ECMContractLegal)*_, проверка действия скрипта происходила на тестовой среде Исполнителя, для БД, восстановленной с промышленной среды, перечень таблиц может отличаться. В случае невозможности удаления записей из какой-либо таблицы, следует руководствоваться уведомлениями об ошибках в окне сообщений.\r\n{{collapse(sql-скрипт:)\r\n<pre>\r\ndelete from DocumentCommonInfo where CardTypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be';\r\ndelete from ECMContractLegal where id in (select id from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be');\r\ndelete from ECMContractIndividual where id in (select id from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be');\r\ndelete from ECMContractIndividual where DocID in (select id from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be');\r\ndelete from ECMCommonInfo where id in (select id from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be');\r\ndelete from ECMConstant where id in (select id from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be');\r\ndelete from FileVersions where ID in (select RowID from Files where id in (select id from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be'));\r\ndelete from Files where id in (select id from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be');\r\ndelete from OutgoingRefDocs where id in (select id from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be');\r\ndelete from ECMLNATypesOfActivity where id in (select id from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be');\r\ndelete from ECMObjectInDocument where id in (select id from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be');\r\ndelete from ECMApprover where id in (select id from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be');\r\ndelete from ECMContractAccess where DocID in (select id from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be');\r\ndelete from KrTask where id in (select RowID from tasks where id in (select id from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be'));\r\ndelete from WfResolutions where id in (select RowID from tasks where id in (select id from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be'));\r\ndelete from TaskCommonInfo where id in (select RowID from tasks where id in (select id from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be'));\r\ndelete from Tasks where id in (select id from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be');\r\ndelete from TaskHistory where id in (select id from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be');\r\ndelete from Instances where TypeID = '700c9e01-63f8-4a33-adf7-85b4f10a93be';\r\n</pre>\r\n}}\r\n\r\n7. Провести импорт карточек сотрудников, выгруженных в п. 1\r\n{{collapse(см. рисунок:)\r\n!http://dl3.joxi.net/drive/2018/04/28/0020/1024/1319936/36/bfa3bdc5ed.jpg!\r\n}}\r\nЕсли в процессе импорта возникнет уведомление о том, что карточка уже существует в системе, данную карточку можно проигнорировать и, в случае необходимости, поправить вручную.\r\n8. Опубликовать приложения и запустить Chronos. Изменения в представлениях можно не исправлять, т.к. при импорте конфигурации из репозитория, они будут исправлены.\r\n";
            Parser parser = new Parser();
            var result = parser.GetParseToTessaHTMLString(testString, filesDirectory, attachemntsIds, true);
        }
    }
}
